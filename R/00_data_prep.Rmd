---
title: "Dog-SEP"
subtitle: "Data preps"
author: "Radoslaw Panczak"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    highlight: pygments
    keep_md: no
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width=8, fig.height=6, dpi=300, out.width="800px", out.height="600px")

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
set.seed(12345)
options(scipen = 999)

library(pacman) 
p_load(tidyverse, readxl, magrittr,
       janitor, sjmisc, kableExtra,
       sf, tmap, rmapshaper)

tmap_mode("view") # makes map interactive

# library("tidylog")
# library("conflicted")
# for (f in getNamespaceExports("tidylog")) {
#   conflicted::conflict_prefer(f, "tidylog", quiet = TRUE)
# }
```

<!-- ------------------------------------------------------------ --> 

# Neighbourhood boundaries

## BCC suburbs

```{r eval=FALSE, include=FALSE}
SUB <- read_csv("data/geo/raw/suburb-and-adjoining-suburb-november-2019.zip") %>% 
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  select(suburb_name) %>% 
  rename(SSC_NAME16 = suburb_name) %>%  
  distinct() %>% 
  mutate(SSC_NAME16 = str_to_title(SSC_NAME16)) %>% 
  arrange(SSC_NAME16)

saveRDS(SUB, "data/geo/clean/SUB.Rds")
```

Full (?) list of Brisbane suburbs. 

```{r}
SUB <- readRDS("data/geo/clean/SUB.Rds")

# glimpse(SUB)

SUB %>% 
  slice(1:5) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

This might very well include areas with no pops (and therefore no SEIFA).

```{r}
SUB %>% 
  filter(str_detect(SSC_NAME16, 
                    regex("port", ignore_case = TRUE))) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## ABS

Names from Brisbane containing `(Brisbane - Qld)`, names from Qld containing `(Qld)` have to cleaned to match BCC data.

`McDowall` is called `McDowall` and `Mount Coot-tha` is `Mount Coot-Tha`.

```{r eval=FALSE, include=FALSE}
SSC <- st_read("data/geo/raw/1270055003_ssc_2016_aust_shape/SSC_2016_AUST.shp", 
               stringsAsFactors = FALSE) %>% 
  mutate(SSC_CODE16 = as.integer(SSC_CODE16)) %>% 
  select(-STE_NAME16, -STE_CODE16, -AREASQKM16) %>% 	
  st_transform(3112) %>% 	
  filter(!st_is_empty(geometry)) %>% 
  mutate(SSC_NAME16_orig = SSC_NAME16) %>%  
  mutate(SSC_NAME16 = str_remove(SSC_NAME16, 
                                 fixed(" (Brisbane - Qld)"))) %>% 
  mutate(SSC_NAME16 = str_remove(SSC_NAME16, 
                                 fixed(" (Qld)"))) %>% 
  mutate(SSC_NAME16 = ifelse(SSC_NAME16 == "McDowall",
                             "Mcdowall", SSC_NAME16)) %>% 
  mutate(SSC_NAME16 = ifelse(SSC_NAME16 == "Mount Coot-tha",
                             "Mount Coot-Tha", SSC_NAME16))

# SSC <- ms_simplify(SSC, keep = 0.05, weighting = 0.7) # default settings

saveRDS(SSC, "data/geo/SSC_2016_AUST.Rds")
```

```{r}
SSC <- readRDS("data/geo/SSC_2016_AUST.Rds")
```

Areas without matches using original names

```{r}
SUB %>% 
  left_join(SSC, by = c("SSC_NAME16" = "SSC_NAME16")) %>% 
  select(-geometry) %>% 
  filter(SSC_NAME16 != SSC_NAME16_orig) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

`Stones Corner` doesn't exist in ABS but it does in BCC. It seems it's part of [`Greenslopes`](https://quickstats.censusdata.abs.gov.au/census_services/getproduct/census/2016/quickstat/SSC31254?opendocument).

```{r}
SUB %>% 
  left_join(SSC) %>% 
  select(-geometry) %>% 
  filter(is.na(SSC_CODE16))
```

Full map

```{r}
SSC %<>% 
  right_join(SUB) %>%
  filter(SSC_NAME16 != "Stones Corner")

# SSC %>% 
#   plot(max.plot = 1)

qtm(SSC, fill = NULL, borders = "darkorchid4", 
    text ="SSC_NAME16", text.col = "darkorchid4")
```


```{r eval=FALSE, include=FALSE}
## QSC
# data not needed at the moment

LB <- st_read("data/geo/raw/QSC_Extracted_Data_20190816_111155192000-13108/Locality_Boundaries.shp", 
              stringsAsFactors = FALSE) %>% 
  select(-ADMINTYPEN, -CA_AREA_SQ, -SHAPE_Leng, -SHAPE_Area) %>% 
  mutate(LOC_CODE = as.integer(LOC_CODE)) %>% 
  filter(!st_is_empty(geometry)) %>%
  filter(LGA == "Brisbane City") %>%
  select(-LGA) %>%
  # st_drop_geometry() %>% 
  st_transform(3112)

# LB <- ms_simplify(LB, keep = 0.05, weighting = 0.7) # default settings

saveRDS(LB, "data/geo/clean/Locality_Boundaries.Rds")

plot(st_geometry(LB))

qtm(LB, fill = NULL, borders = "darkorchid4", 
    text ="LOCALITY", text.col = "darkorchid4")

test <- LB %>% 
  st_drop_geometry() %>% 
  left_join(SSC, by = c("LOCALITY" = "SSC_NAME16")) %>% 
  select(-geometry)

test <- LB %>% 
  st_drop_geometry() %>% 
  left_join(SUB %>% mutate(exist = 1), 
            by = c("LOCALITY" = "SSC_NAME16"))

# Three changes with capital letter problems
LB %<>% 
  mutate(LOCALITY = ifelse(LOCALITY == "MacGregor",
                           "Macgregor", LOCALITY)) %>%
  mutate(LOCALITY = ifelse(LOCALITY == "McDowall",
                           "Mcdowall", LOCALITY)) %>%
  mutate(LOCALITY = ifelse(LOCALITY == "Mount Coot-tha",
                           "Mount Coot-Tha", LOCALITY))

# Now one extra 'suburb' of Moreton Bay
LB %>% 
  st_drop_geometry() %>% 
  left_join(SUB %>% mutate(exist = 1), 
            by = c("LOCALITY" = "SSC_NAME16")) %>% 
  filter(is.na(exist)) %>% 
  select(LOCALITY)

# And one extra Stones Creek 
LB %>% 
  st_drop_geometry() %>% 
  filter(LOCALITY == "Stones Corner")
```

<!-- ------------------------------------------------------------ --> 

# SEIFA

```{r}
SEIFA <- read_xls("data/SEIFA/raw/2033055001 - ssc indexes.xls", 
                  sheet = "Table 1", skip = 5, n_max = 13719, na = "-") %>% 
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  dplyr::rename(SSC_CODE16 = x1,
                SSC_NAME16 = x2,
                IRSD = score_3,
                IRSD_d = decile_4,
                IRSAD = score_5,
                IRSAD_d = decile_6,
                IER = score_7,
                IER_d = decile_8,
                IEO = score_9,
                IEO_d = decile_10,
                URP = x11,
                caution = x12) %>% 
  mutate(SSC_CODE16 = as.integer(SSC_CODE16),
         IRSD = as.integer(IRSD),
         IRSAD = as.integer(IRSAD),
         IER = as.integer(IER),
         IEO = as.integer(IEO),
         IRSD_d = as.integer(IRSD_d),
         IRSAD_d = as.integer(IRSAD_d),
         IER_d = as.integer(IER_d),
         IEO_d = as.integer(IEO_d),
         URP = as.integer(URP)
  ) %>% 
  mutate(caution = as.logical(ifelse(is.na(caution), "False", "True")))

saveRDS(SEIFA, "data/SEIFA/clean/SEIFA.Rds")
```

## Coverage

Data for Australia, example of IRSD.

```{r}
SEIFA <- readRDS("data/SEIFA/clean/SEIFA.Rds")

frq(SEIFA$IRSD_d)

SEIFA %>% 
  ggplot(aes(x = IRSD_d)) + 
  geom_bar() 

SEIFA %>% 
  ggplot(aes(x = as.factor(IRSD_d), y = IRSD)) + 
  geom_boxplot(varwidth = TRUE) 
```

Brisbane suburbs only 

```{r}
SSC %<>% 
  left_join(SEIFA, by = c("SSC_CODE16", "SSC_CODE16")) %>% 
  select(-SSC_NAME16.y) %>% 
  rename(SSC_NAME16 = SSC_NAME16.x)

# SSC %>% 
#   st_drop_geometry() %>% 
#   glimpse()

frq(SSC$IRSD_d)

SSC %>% 
  ggplot(aes(x = IRSD_d)) + 
  geom_bar() 

SSC %>% 
  filter(!is.na(IRSD_d)) %>% 
  ggplot(aes(x = as.factor(IRSD_d), y = IRSD)) + 
  geom_boxplot(varwidth = TRUE) 
```

## Missing

Few areas with missing SEIFA

```{r}
SSC %>% 
  st_drop_geometry() %>% 
  filter_at(vars(ends_with("_d")), any_vars(is.na(.))) %>%   select(SSC_NAME16, ends_with("_d"), URP)
```

These were excluded.

```{r}
SSC %<>% 
  filter_at(vars(ends_with("_d")), all_vars(!is.na(.))) 
```

## Caution

Few cases with ABS flag `caution`.

```{r}
frq(SSC$caution)
```

Usually with very small pop numbers.

```{r}
SSC %>% 
  st_drop_geometry() %>% 
  group_by(caution) %>% 
  summarise(mean = mean(URP),
            min = min(URP),
            max = max(URP))
```

Apart Lake Manchester.

## 'Local' deciles

```{r}
SSC %<>% 
  mutate(IRSD_d_orig = IRSD_d) %>% 
  mutate(IRSD_d = ntile(IRSD, 10)) %>%
  mutate(IRSAD_d_orig = IRSAD_d) %>% 
  mutate(IRSAD_d = ntile(IRSAD, 10)) %>%
  mutate(IER_d_orig = IER_d) %>% 
  mutate(IER_d = ntile(IER, 10)) %>%
  mutate(IEO_d_orig = IEO_d) %>% 
  mutate(IEO_d = ntile(IEO, 10))

# frq(SSC$IRSD_d_orig)
# frq(SSC$IRSD_d)

SSC %>% 
  st_drop_geometry() %>% 
  tabyl(IRSD_d_orig, IRSD_d)

# frq(SSC$IRSAD_d)

SSC %>% 
  st_drop_geometry() %>% 
  tabyl(IRSAD_d_orig, IRSAD_d)

# frq(SSC$IER_d)

SSC %>% 
  st_drop_geometry() %>% 
  tabyl(IER_d_orig, IER_d)

# frq(SSC$IEO_d)

SSC %>% 
  st_drop_geometry() %>% 
  tabyl(IEO_d_orig, IEO_d)
```

```{r}
tm_shape(SSC) +
  tm_polygons(col = "IRSD_d", n = 10, palette = "div",
              id = "SSC_NAME16", 
              popup.vars = c("SSC_NAME16", "IRSD_d", "IRSD"))
```

<!-- ------------------------------------------------------------ --> 

# Dog cost 

```{r include=FALSE}
dog_cost <- read_xlsx("data/costs/raw/dog_expensive.xlsx") %>% 
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  # fill(web_source)
  select(-web_source) %>% 
  # filter(source == "lifestyle") %>% 
  rename(dog_breed = breed) %>%  
  select(dog_breed) %>% 
  distinct() %>% 
  arrange(dog_breed)

saveRDS(dog_cost, "data/costs/clean/dog_cost.Rds")
```


```{r}
dog_cost <- readRDS("data/costs/clean/dog_cost.Rds")

kableExtra::kable(dog_cost)
```

<!-- ------------------------------------------------------------ --> 

# Dog insurance

```{r eval=FALSE, include=FALSE}
# packages needed
# install.packages("rvest")

library(rvest)
library(tidyverse)

# scraping table done with this using chrome: https://www.r-bloggers.com/using-rvest-to-scrape-an-html-table/
url <- 'https://top10petinsurance.com.au/pet-insurance-prices/'   

dog_insurance <- url %>%
  xml2::read_html() %>%
  html_nodes(xpath='//*[@id="post-1016"]/div/table') %>%
  html_table()

dog_insurance <- dog_insurance[[1]]

head(dog_insurance)

saveRDS(dog_insurance, "data/costs/raw/dog_insurance.Rds") # extracted on the 30 March 2020
```

```{r}
dog_insurance <- readRDS("data/costs/raw/dog_insurance.Rds")

dog_insurance <- readRDS("data/costs/raw/dog_insurance.Rds") %>% 
  as_tibble() %>% 
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  # select(-) %>% 
  mutate(average_accident_policy_cost_annual = 
           gsub(",", "",
                average_accident_policy_cost_annual, 
                fixed = TRUE),
         average_illness_policy_cost_annual = 
           gsub(",", "",
                average_illness_policy_cost_annual, 
                fixed = TRUE),
         average_comprehensive_policy_cost_annual = 
           gsub(",", "",
                average_comprehensive_policy_cost_annual, 
                fixed = TRUE)
  ) %>% 
  mutate(average_accident_policy_cost_annual = 
           as.numeric(gsub("$", "",
                           average_accident_policy_cost_annual, 
                           fixed = TRUE)),
         average_illness_policy_cost_annual = 
           as.numeric(gsub("$", "",
                           average_illness_policy_cost_annual, 
                           fixed = TRUE)),
         average_comprehensive_policy_cost_annual = 
           as.numeric(gsub("$", "",
                           average_comprehensive_policy_cost_annual, 
                           fixed = TRUE))
  )

saveRDS(dog_insurance, "data/costs/clean/dog_insurance.Rds") # extracted on the 30 March 2020
```

```{r}
dog_insurance <- readRDS("data/costs/clean/dog_insurance.Rds")
```

## Three major categories

```{r}
dog_insurance %>% 
  frq(cost_compared_to_other_breeds) %>% 
  kableExtra::kable()
```

## Individual breeds

```{r}
dog_insurance %>% 
  select(dog_breed, cost_compared_to_other_breeds) %>% 
  kableExtra::kable()
```

<!-- ------------------------------------------------------------ --> 

# Dog ownership 